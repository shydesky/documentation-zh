<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>部署 - 波场文档</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u90e8\u7f72";
    var mkdocs_page_input_path = "developers/deployment.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> 波场文档</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <span class="caption-text">简介</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../introduction/">项目仓库</a>
                </li>
                <li class="">
                    
    <a class="" href="../../introduction/dpos/">波场共识</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">接口</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../api/http/">Http接口</a>
                </li>
                <li class="">
                    
    <a class="" href="../../api/rpc/">Rpc接口</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">机制与算法</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../mechanism&algorithm/sr/">超级代表与委员会</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanism&algorithm/trc10/">TRC-10</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanism&algorithm/account/">账户模型</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanism&algorithm/resource/">资源模型</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanism&algorithm/dex/">去中心化交易所</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanism&algorithm/multi-signatures/">多重签名</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanism&algorithm/shielded-transaction/">匿名交易</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanism&algorithm/systemContracts/">系统合约</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">架构</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../architecture/network/">网络</a>
                </li>
                <li class="">
                    
    <a class="" href="../../architecture/database/">数据库</a>
                </li>
                <li class="">
                    
    <a class="" href="../../architecture/plugin/">插件</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">智能合约</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../contracts/tvm/">虚拟机</a>
                </li>
                <li class="">
                    
    <a class="" href="../../contracts/compiler/">编译器</a>
                </li>
                <li class="">
                    
    <a class="" href="../../contracts/contract/">合约</a>
                </li>
                <li class="">
                    
    <a class="" href="../../contracts/trc20/">TRC-20</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">开发者</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../official-public-nodes/">官方节点</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">部署</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#_1">部署文档</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#_2">前提</a></li>
        
            <li><a class="toctree-l4" href="#_3">部署指南</a></li>
        
            <li><a class="toctree-l4" href="#_4">日志与网络连接验证</a></li>
        
            <li><a class="toctree-l4" href="#_5">优雅的停止节点</a></li>
        
            <li><a class="toctree-l4" href="#_6">快速部署节点</a></li>
        
            <li><a class="toctree-l4" href="#grpc-gateway">Grpc Gateway部署</a></li>
        
            <li><a class="toctree-l4" href="#_7">事件订阅部署</a></li>
        
            <li><a class="toctree-l4" href="#_8">事件订阅数据查询服务部署</a></li>
        
            <li><a class="toctree-l4" href="#_9">高级配置</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../run_in_IDEA/">在IDEA中启动节点</a>
                </li>
                <li class="">
                    
    <a class="" href="../resources/">资源</a>
                </li>
                <li class="">
                    
    <a class="" href="../contribution/">参与开发</a>
                </li>
                <li class="">
                    
    <a class="" href="../incentives/">激励政策</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">客户端</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../clients/wallet-cli/">命令行钱包</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../q&a/qa/">常见问题</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../glossary/">术语</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">波场文档</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>开发者 &raquo;</li>
        
      
    
    <li>部署</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="_1">部署文档</h1>
<h2 id="_2">前提</h2>
<p>分别为fullnode和soliditynode创建一个目录</p>
<blockquote>
<p>NOTE: 原则上不鼓励继续使用 SolidityNode, 目前 FullMode 可以替代 SolidityNode 的功能.</p>
</blockquote>
<pre><code class="text">/deploy/fullnode
/deploy/soliditynode
</code></pre>

<p>克隆最新的master分支上的代码<a href="https://github.com/tronprotocol/java-tron">https://github.com/tronprotocol/java-tron</a> 到</p>
<pre><code class="text">/deploy/java-tron
</code></pre>

<p>请确保已经安装恰当的依赖环境。</p>
<ul>
<li>JDK 1.8 (JDK 1.9+ is not supported yet)</li>
<li>On Linux Ubuntu system (e.g. Ubuntu 16.04.4 LTS), ensure that the machine has <a href="https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-get-on-ubuntu-16-04"><strong>Oracle JDK 8</strong></a>, instead of having <strong>Open JDK 8</strong> in the system. If you are building the source code by using <strong>Open JDK 8</strong>, you will get <a href="https://github.com/tronprotocol/java-tron/issues/337"><strong>Build Failed</strong></a> result.</li>
<li>Open <strong>UDP</strong> ports for connection to the network</li>
<li><strong>MINIMUM</strong> 2 CPU Cores</li>
</ul>
<h2 id="_3">部署指南</h2>
<p>1.&nbsp;编译java-tron项目</p>
<pre><code class="text">cd /deploy/java-tron
./gradlew build
</code></pre>

<p>2.&nbsp;复制FullNode.jar和SolidityNode.jar以及相应的配置文件到各自的目录</p>
<pre><code class="text">download your needed configuration file from https://github.com/tronprotocol/TronDeployment.

main_net_config.conf is the configuration for MainNet, and test_net_config.conf is the configuration for TestNet.

please rename the configuration file to `config.conf` and use this config.conf to start FullNode and SoliditNode.

cp build/libs/FullNode.jar ../fullnode

cp build/libs/SolidityNode.jar ../soliditynode
</code></pre>

<p>3.&nbsp;用以下命令运行FullNode</p>
<pre><code class="text">java -jar FullNode.jar -c config.conf // make sure that your config.conf is downloaded from https://github.com/tronprotocol/TronDeployment
</code></pre>

<p>4.&nbsp;配置SolidityNode配置文件</p>
<p>需要编辑<code>config.conf</code>文件来连接本地的FullNode。修改<code>node</code>里的<code>trustNode</code>为<code>127.0.0.1:50051</code>，这是默认rpc端口。设置<code>listen.port</code>为1024-65535间任意数字。不要使用0-1024间的数字，因为可能会导致与系统服务冲突。同样，为了避免冲突，可以把<code>rpc port</code>改为<code>50052</code>。</p>
<p><strong>请为FullNode转发UDP端口18888</strong></p>
<pre><code class="text">rpc {
      port = 50052
    }
</code></pre>

<p>5.&nbsp;用以下命令运行SolidityNode</p>
<pre><code class="text">java -jar SolidityNode.jar -c config.conf //make sure that your config.conf is downloaded from https://github.com/tronprotocol/TronDeployment
</code></pre>

<p>6.&nbsp;在公链环境中运行超级节点</p>
<pre><code class="text">java -jar FullNode.jar -p your private key --witness -c your config.conf(Example：/data/java-tron/config.conf)
Example:
java -jar FullNode.jar -p 650950B193DDDDB35B6E48912DD28F7AB0E7140C1BFDEFD493348F02295BD812 --witness -c /data/java-tron/config.conf
</code></pre>

<p>这与运行一个个人测试网相似，除了<code>config.conf</code>中的IP不一样。</p>
<p>7.&nbsp;在个人测试网环境中运行超级节点</p>
<p>你需要修改一下config.conf配置文件内容：</p>
<ul>
<li>Replace existing entry in genesis.block.witnesses with your address</li>
<li>Replace existing entry in seed.node ip.list with your ip list</li>
<li>The first Super Node start, needSyncCheck should be set false</li>
<li>Set p2p version to 61</li>
</ul>
<pre><code class="text">cd build/libs
java -jar FullNode.jar -p your private key --witness -c your config.conf (Example：/data/java-tron/config.conf)
Example:
java -jar FullNode.jar -p 650950B193DDDDB35B6E48912DD28F7AB0E7140C1BFDEFD493348F02295BD812 --witness -c /data/java-tron/config.conf
</code></pre>

<h2 id="_4">日志与网络连接验证</h2>
<p>日志位于<code>/deploy/\*/logs/tron.log</code>。 使用<code>tail -f /logs/tron.log/</code>命令来查看块同步日志。</p>
<p>你可以看到类似如下块同步的日志信息：</p>
<p><strong>FullNode</strong></p>
<pre><code class="text">12:00:57.658 INFO  [pool-7-thread-1] [o.t.c.n.n.NodeImpl](NodeImpl.java:830) Success handle block Num:236610,ID:0000000000039c427569efa27cc2493c1fff243cc1515aa6665c617c45d2e1bf
</code></pre>

<p><strong>SolidityNode</strong></p>
<pre><code class="text">12:00:40.691 INFO  [pool-17-thread-1] [o.t.p.SolidityNode](SolidityNode.java:88) sync solidity block, lastSolidityBlockNum:209671, remoteLastSolidityBlockNum:211823
</code></pre>

<h2 id="_5">优雅的停止节点</h2>
<p>创建stop.sh文件，使用命令<code>kill -15</code>关闭java-tron.jar（或者FullNode.jar、SolidityNode.jar）。
修改pid=<code>ps -ef |grep java-tron.jar |grep -v grep |awk '{print $2}'</code>来找到正确的pid。</p>
<pre><code class="text">#!/bin/bash
while true; do
  pid=`ps -ef |grep java-tron.jar |grep -v grep |awk '{print $2}'`
  if [ -n &quot;$pid&quot; ]; then
    kill -15 $pid
    echo &quot;The java-tron process is exiting, it may take some time, forcing the exit may cause damage to the database, please wait patiently...&quot;
    sleep 1
  else
    echo &quot;java-tron killed successfully!&quot;
    break
  fi
done
</code></pre>

<h2 id="_6">快速部署节点</h2>
<p>下载快速部署脚本，根据部署节点类型，执行脚本。</p>
<h3>使用范围</h3>

<p>脚本可以再Linux/MacOS上使用，不支持Windows系统。
只支持FullNode与SolidityNode的部署。</p>
<h3>下载运行脚本</h3>

<pre><code class="shell">wget https://raw.githubusercontent.com/tronprotocol/TronDeployment/master/deploy_tron.sh -O deploy_tron.sh
</code></pre>

<h3>参数含义</h3>

<pre><code class="shell">bash deploy_tron.sh --app [FullNode|SolidityNode] --net [mainnet|testnet|privatenet] --db [keep|remove|backup] --heap-size &lt;heapsize&gt;

--app Optional, Running application. The default node is Fullnode and it could be FullNode or SolidityNode.
--net Optional, Connecting network. The default network is mainnet and it could be mainnet, testnet.
--db  Optional, The way of data processing could be keep, remove and backup. Default is keep. If you launch two different networks, like from mainnet to testnet or from testnet to mainnet, you need to delete database.
--trust-node  Optional, It only works when deploying SolidityNode. Default is 127.0.0.1:50051. The specified gRPC service of Fullnode, like 127.0.0.1:50051 or 13.125.249.129:50051.
--rpc-port  Optional, Port of grpc. Default is 50051. If you deploy SolidityNode and FullNode on the same host，you need to configure different ports.
--commit  Optional, commitid of project.
--branch  Optional, branch of project.  Mainnet default is latest release and Testnet default is master.
--heap-size  Optional, jvm option: Xmx. The default heap-size is 0.8 * memory size.
--work_space  Optional, default is current directory.
</code></pre>

<h3>部署FullNode</h3>

<pre><code class="shell">wget https://raw.githubusercontent.com/tronprotocol/TronDeployment/master/deploy_tron.sh -O deploy_tron.sh
bash deploy_tron.sh
</code></pre>

<h3>部署SolidityNode</h3>

<pre><code class="shell">wget https://raw.githubusercontent.com/tronprotocol/TronDeployment/master/deploy_tron.sh -O deploy_tron.sh
# User can self-configure the IP and Port of GRPC service in the turst-node field of SolidityNode. trust-node is the fullnode you just deploy.
bash deploy_tron.sh --app SolidityNode --trust-node &lt;grpc-ip:grpc-port&gt;
</code></pre>

<h3> FullNode和SolidityNode部署在同一主机上</h3>

<pre><code class="shell"># You need to configure different gRPC ports on the same host because gRPC port is available on SolidityNode and FullNodeConfigure and it cannot be set as default value 50051. In this case the default value of rpc port is set as 50041.
wget https://raw.githubusercontent.com/tronprotocol/TronDeployment/master/deploy_tron.sh -O deploy_tron.sh
bash deploy_tron.sh --app FullNode
bash deploy_tron.sh --app SolidityNode --rpc-port 50041
</code></pre>

<h2 id="grpc-gateway">Grpc Gateway部署</h2>
<h3> 前提 </h3>

<p>请参照：<a href="https://github.com/tronprotocol/grpc-gateway">https://github.com/tronprotocol/grpc-gateway</a>
安装Golang, Protoc, 并且设置$GOPATH环境变量。</p>
<h3> 下载运行脚本 </h3>

<pre><code class="shell">wget https://raw.githubusercontent.com/tronprotocol/TronDeployment/master/deploy_grpc_gateway.sh -O deploy_grpc_gateway.sh
</code></pre>

<h3> 参数含义 </h3>

<pre><code class="shell">bash deploy_grpc_gateway.sh --rpchost [rpc host ip] --rpcport [rpc port number] --httpport [http port number]

--rpchost The fullnode or soliditynode IP where the grpc service is provided. Default value is &quot;localhost&quot;.
--rpcport The fullnode or soliditynode port number grpc service is consuming. Default value is 50051.
--httpport The port intends to provide http service provided by grpc gateway. Default value is 18890.
</code></pre>

<h3> 示例 </h3>

<p>使用默认配置：</p>
<pre><code class="shell">bash deploy_grpc_gateway.sh
</code></pre>

<p>使用自定义配置：</p>
<pre><code class="shell">bash deploy_grpc_gateway.sh --rpchost 127.0.0.1 --rpcport 50052 --httpport 18891
</code></pre>

<h2 id="_7">事件订阅部署</h2>
<ul>
<li><strong>api</strong> 模块定义了介于java-tron与插件间的事件订阅接口。</li>
<li><strong>app</strong> 模块是加载插件示例，开发者可以用来调试。</li>
<li><strong>kafkaplugin</strong> 模块是kafka的实现。它实现了IPluginEventListener，它从java-tron接受事件并转给kafka服务。</li>
<li><strong>mongodbplugin</strong> 模块是mongodb的实现。</li>
</ul>
<h3> 搭建运行环境 </h3>

<ol>
<li>Clone the repo <code>git clone https://github.com/tronprotocol/event-plugin.git</code></li>
<li>Go to eventplugin <code>cd event-plugin</code></li>
<li>
<p>run <code>./gradlew build</code></p>
</li>
<li>
<p>这一步会生成<code>plugin-kafka-1.0.0.zip</code>，位于<code>event-plugin/build/plugins/</code>目录下。</p>
</li>
</ol>
<h3> 编辑java-tron的 **config.conf** 文件，增加以下字段：</h3>

<pre><code>event.subscribe = {
    path = &quot;&quot; // absolute path of plugin
    server = &quot;&quot; // target server address to receive event triggers
    dbconfig=&quot;&quot; // dbname|username|password
    topics = [
        {
          triggerName = &quot;block&quot; // block trigger, the value can't be modified
          enable = false
          topic = &quot;block&quot; // plugin topic, the value could be modified
        },
        {
          triggerName = &quot;transaction&quot;
          enable = false
          topic = &quot;transaction&quot;
        },
        {
          triggerName = &quot;contractevent&quot;
          enable = true
          topic = &quot;contractevent&quot;
        },
        {
          triggerName = &quot;contractlog&quot;
          enable = true
          topic = &quot;contractlog&quot;
        }
    ]

    filter = {
       fromblock = &quot;&quot; // the value could be &quot;&quot;, &quot;earliest&quot; or a specified block number as the beginning of the queried range
       toblock = &quot;&quot; // the value could be &quot;&quot;, &quot;latest&quot; or a specified block number as end of the queried range
       contractAddress = [
           &quot;&quot; // contract address you want to subscribe, if it's set to &quot;&quot;, you will receive contract logs/events with any contract address.
       ]

       contractTopic = [
           &quot;&quot; // contract topic you want to subscribe, if it's set to &quot;&quot;, you will receive contract logs/events with any contract topic.
       ]
    }
}


</code></pre>

<ul>
<li><strong>path</strong>: "plugin-kafka-1.0.0.zip"文件的绝对路径</li>
<li><strong>server</strong>: Kafka服务地址</li>
<li><strong>topics</strong>: 每一种事件匹配一个Kafka主题，我们支持四种事件订阅：区块事件，交易事件，合约事件以及合约日志事件</li>
<li><strong>dbconfig</strong>: mongodb的配置，dbname|username|password。如果使用kafka，可以忽略这个参数。</li>
<li><strong>triggerName</strong>: 触发类型，只读。</li>
<li><strong>enable</strong>: 是否开启事件订阅。</li>
<li><strong>topic</strong>: kafka接收事件的主题。请确保Kafka在运行中。</li>
<li><strong>filter</strong>: 事件订阅过滤选项。
 <strong>注意</strong>: 如果服务器地址不是127.0.0.1, 请在config/server.properties文件中设置listeners=PLAINTEXT://:9092，advertised.listeners to PLAINTEXT://host_ip:9092</li>
</ul>
<h3 id="kafka"> 安装Kafka </h3>

<p><strong>Mac环境</strong>:</p>
<pre><code>brew install kafka
</code></pre>

<p><strong>Linux环境</strong>:</p>
<pre><code>cd /usr/local
wget http://archive.apache.org/dist/kafka/0.10.2.2/kafka_2.10-0.10.2.2.tgz
tar -xzvf kafka_2.10-0.10.2.2.tgz
mv kafka_2.10-0.10.2.2 kafka

add &quot;export PATH=$PATH:/usr/local/kafka/bin&quot; to end of /etc/profile
source /etc/profile


kafka-server-start.sh /usr/local/kafka/config/server.properties &amp;

</code></pre>

<p><strong>注意</strong>: 请确保Kafka的版本与build.gradle中eventplugin项目的版本一致。</p>
<h3> 运行Kafka </h3>

<p><strong>Mac环境</strong>:</p>
<pre><code>zookeeper-server-start /usr/local/etc/kafka/zookeeper.properties &amp; kafka-server-start /usr/local/etc/kafka/server.properties
</code></pre>

<p><strong>Linux环境</strong>:</p>
<pre><code>zookeeper-server-start.sh /usr/local/kafka/config/zookeeper.properties &amp;
Sleep about 3 seconds
kafka-server-start.sh /usr/local/kafka/config/server.properties &amp;
</code></pre>

<h3> 创建主题接受事件，主题的定义位于config.conf文件中 </h3>

<p><strong>Mac环境</strong>:</p>
<pre><code>kafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic block
kafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic transaction
kafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic contractlog
kafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic contractevent
</code></pre>

<p><strong>Linux环境</strong>:</p>
<pre><code>kafka-topics.sh  --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic block
kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic transaction
kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic contractlog
kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic contractevent
</code></pre>

<h3> Kafka用户 </h3>

<p><strong>Mac环境</strong>:</p>
<pre><code>kafka-console-consumer --bootstrap-server localhost:9092  --topic block
kafka-console-consumer --bootstrap-server localhost:9092  --topic transaction
kafka-console-consumer --bootstrap-server localhost:9092  --topic contractlog
kafka-console-consumer --bootstrap-server localhost:9092  --topic contractevent
</code></pre>

<p><strong>Linux环境</strong>:</p>
<pre><code>kafka-console-consumer.sh --zookeeper localhost:2181 --topic block
kafka-console-consumer.sh --zookeeper localhost:2181 --topic transaction
kafka-console-consumer.sh --zookeeper localhost:2181 --topic contractlog
kafka-console-consumer.sh --zookeeper localhost:2181 --topic contractevent
</code></pre>

<h3> 在Java-tron中加载插件 </h3>

<ul>
<li>add --es to command line, for example:</li>
</ul>
<pre><code> java -jar FullNode.jar -p privatekey -c config.conf --es
</code></pre>

<h3> 事件订阅过滤 </h3>

<p>事件订阅过滤参数在config.conf文件中设置：</p>
<pre><code>filter = {
       fromblock = &quot;&quot; // the value could be &quot;&quot;, &quot;earliest&quot; or a specified block number as the beginning of the queried range
       toblock = &quot;&quot; // the value could be &quot;&quot;, &quot;latest&quot; or a specified block number as end of the queried range
       contractAddress = [
           &quot;TVkNuE1BYxECWq85d8UR9zsv6WppBns9iH&quot; // contract address you want to subscribe, if it's set to &quot;&quot;, you will receive contract logs/events with any contract address.
       ]

       contractTopic = [
           &quot;f0f1e23ddce8a520eaa7502e02fa767cb24152e9a86a4bf02529637c4e57504b&quot; // contract topic you want to subscribe, if it's set to &quot;&quot;, you will receive contract logs/events with any contract topic.
       ]
    }
</code></pre>

<h3 id="mongo"> 下载并安装MongoDB </h3>

<p><strong> 建议配置 </strong></p>
<ul>
<li>CPU/ RAM: 16Core / 32G</li>
<li>DISK: 500G</li>
<li>System: CentOS 64</li>
</ul>
<p>MongoDB的版本是<strong>4.0.4</strong>，以下是安装命令:</p>
<ul>
<li>cd /home/java-tron</li>
<li>curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-4.0.4.tgz</li>
<li>tar zxvf mongodb-linux-x86_64-4.0.4.tgz</li>
<li>mv mongodb-linux-x86_64-4.0.4 mongodb</li>
</ul>
<p><strong> 设计环境变量 </strong></p>
<ul>
<li>export MONGOPATH=/home/java-tron/mongodb/</li>
<li>export PATH=$PATH:$MONGOPATH/bin</li>
</ul>
<p><strong> 创建配置文件 </strong></p>
<p>The path is : /etc/mongodb/mgdb.conf</p>
<ul>
<li>cd /etc/mongodb</li>
<li>touch mgdb.conf</li>
</ul>
<p>创建数据和日志文件夹，并把它们的绝对路径加入mgdb.conf</p>
<p><strong> 示例 </strong></p>
<ul>
<li>dbpath=/home/java-tron/mongodb/data</li>
<li>logpath=/home/java-tron/mongodb/log/mongodb.log</li>
<li>port=27017</li>
<li>logappend=true</li>
<li>fork=true</li>
<li>bind_ip=0.0.0.0</li>
<li>auth=true</li>
<li>wiredTigerCacheSizeGB=2</li>
</ul>
<p><strong> 注意 </strong>
- bind_ip must be configured to 0.0.0.0，otherwise remote connection will be refused.
- wiredTigerCacheSizeGB, must be configured to prevent OOM</p>
<p><strong> 运行MongoDB </strong></p>
<ul>
<li>mongod  --config /etc/mongodb/mgdb.conf</li>
</ul>
<p><strong> 创建管理员账户 </strong>
- mongo
- use admin
- db.createUser({user:"root",pwd:"admin",roles:[{role:"root",db:"admin"}]})</p>
<p><strong> 创建事件日志以及所有者账户 </strong></p>
<ul>
<li>db.auth("root", "admin")</li>
<li>use eventlog</li>
<li>db.createUser({user:"tron",pwd:"123456",roles:[{role:"dbOwner",db:"eventlog"}]})</li>
</ul>
<blockquote>
<p>database: eventlog, username:tron, password: 123456</p>
</blockquote>
<p><strong> 防火墙策略 </strong></p>
<ul>
<li>iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 27017 -j ACCEPT</li>
</ul>
<p><strong> 远程连接mongo </strong></p>
<ul>
<li>mongo 47.90.245.68:27017</li>
<li>use eventlog</li>
<li>db.auth("tron", "123456")</li>
<li>show collections</li>
<li>db.block.find()</li>
</ul>
<p><strong> 查询区块事件触发数据 </strong></p>
<ul>
<li>db.block.find({blockNumber: {$lt: 1000}});  // 返回区块高度小于1000的数据</li>
</ul>
<p><strong> 设置数据库索引 </strong></p>
<p>cd /{projectPath}
sh insertIndex.sh</p>
<h2 id="_8">事件订阅数据查询服务部署</h2>
<h3>下载代码</h3>

<p>git clone https://github.com/tronprotocol/tron-eventquery.git
cd troneventquery</p>
<h3> 编译 </h3>

<ul>
<li>mvn package</li>
</ul>
<p>代码编译成功后，在/troneventquery目录下会生成troneventquery.jar文件。</p>
<p>需要创建一个config.conf配置文件用来设置mongodb的配置属性，我们在/troneventquery/config.conf中提供了个示例，如果有需要可以进行修改。</p>
<p><strong>注意：</strong></p>
<p>config.conf文件应该位于/troneventquery文件夹下。</p>
<ul>
<li>mongo.host=IP</li>
<li>mongo.port=27017</li>
<li>mongo.dbname=eventlog</li>
<li>mongo.username=tron</li>
<li>mongo.password=123456</li>
<li>mongo.connectionsPerHost=8</li>
<li>mongo.threadsAllowedToBlockForConnectionMultiplier=4</li>
</ul>
<p><strong>mongo.dbname</strong>的值是指定的事件订阅数据库的名称，不可以修改。</p>
<h3> 运行 </h3>

<ul>
<li>troneventquery/deploy.sh 是用来部署事件订阅数据查询服务的。</li>
<li>troneventquery/insertIndex.sh 是用来设置mongodb索引来加速查询的。</li>
</ul>
<h2 id="_9">高级配置</h2>
<p>Read the <a href="../../advanced-configuration/">Advanced Configuration</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../run_in_IDEA/" class="btn btn-neutral float-right" title="在IDEA中启动节点">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../official-public-nodes/" class="btn btn-neutral" title="官方节点"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../official-public-nodes/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../run_in_IDEA/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
